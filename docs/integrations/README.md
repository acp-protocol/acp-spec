# ACP MCP Server

Model Context Protocol server for AI Context Protocol. Enables AI assistants to query codebase structure, check constraints, and track debugging sessions.

## Installation

```bash
# Clone and install
cd acp-mcp-server
npm install
npm run build

# Or globally
npm install -g acp-mcp-server
```

## Usage with Claude Desktop

Add to your Claude Desktop config (`~/Library/Application Support/Claude/claude_desktop_config.json` on macOS):

```json
{
  "mcpServers": {
    "acp": {
      "command": "node",
      "args": ["/path/to/acp-mcp-server/dist/index.js", "--dir", "/path/to/your/project"]
    }
  }
}
```

Or if installed globally:

```json
{
  "mcpServers": {
    "acp": {
      "command": "acp-mcp-server",
      "args": ["--dir", "/path/to/your/project"]
    }
  }
}
```

## Tools

### `acp_query`

Query the codebase index.

```
Types:
- symbol: Get symbol details (function, class, etc.)
- file: Get file metadata
- domain: Get domain info (authentication, billing, etc.)
- callers: Who calls this symbol?
- callees: What does this symbol call?
- search: Search symbols and domains
- stats: Get codebase statistics
```

### `acp_constraints`

**Always call this before modifying a file.**

Returns:
- Lock level (frozen, restricted, normal)
- Style requirements
- Quality gates
- Whether modification is allowed

### `acp_expand`

Expand `$VAR_NAME` references to their full values.

### `acp_debug`

Manage debugging sessions for reversible troubleshooting.

```
Actions:
- start: Begin a new debug session
- attempt: Log a debugging attempt
- result: Record success/failure
- revert: Mark an attempt as reverted
- resolve: Close the session
- status: Get session status
```

### `acp_hack`

Track temporary/experimental code.

```
Actions:
- mark: Mark code as a hack with metadata
- list: List all hacks (optionally filter by file/type/expired)
- revert: Remove a hack marker
- cleanup: Find expired hacks
```

## Resources

The server also exposes these MCP resources:

- `acp://cache` - Full codebase index
- `acp://vars` - Variable definitions
- `acp://constraints` - Constraints summary

## Project Setup

Your project needs these files:

```
my-project/
├── .acp.cache.json    # Generated by `acp index`
├── .acp.vars.json     # Generated by `acp vars`
└── AGENTS.md          # Optional: Project-specific AI instructions
```

Generate with the ACP CLI:

```bash
acp index . --vars
```

## Example Workflow

1. AI receives task: "Fix the authentication bug"

2. AI queries for context:
   ```
   acp_query(type="domain", name="authentication")
   ```

3. AI checks constraints before modifying:
   ```
   acp_constraints(file="src/auth/session.ts")
   ```
   
   Returns: `{ "lock": "restricted", "can_modify": { "approval_needed": true } }`

4. AI starts debug session:
   ```
   acp_debug(action="start", data={ "problem": "Users getting 401 errors" })
   ```

5. AI makes change, logs attempt:
   ```
   acp_debug(action="attempt", session_id="debug-123", data={
     "hypothesis": "Race condition in token refresh",
     "change": "Added mutex lock"
   })
   ```

6. If fix fails, AI can revert:
   ```
   acp_debug(action="revert", session_id="debug-123", data={ "attempt": 1 })
   ```

7. When fixed, AI resolves session:
   ```
   acp_debug(action="resolve", session_id="debug-123", data={
     "resolution": "Fixed by adding mutex to prevent race condition"
   })
   ```

## License

MIT
